<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§‚çœ‹è§†é¢‘é¢†ç§¯åˆ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .rules {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .rules h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rules ul {
            list-style: none;
            color: #555;
            font-size: 14px;
        }
        
        .rules li {
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rules li::before {
            content: "â€¢";
            color: #667eea;
            font-weight: bold;
        }
        
        .watch-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .watch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .watch-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }
        
        .back-link {
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            display: inline-block;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .warning {
            background: #fff3cd;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ğŸ¬</div>
        <h1>è§‚çœ‹è§†é¢‘é¢†ç§¯åˆ†</h1>
        <p class="subtitle">å®Œæ•´è§‚çœ‹è§†é¢‘å¹¿å‘Šå³å¯è·å¾—ç§¯åˆ†å¥–åŠ±</p>
        
        <div class="warning">
            âš ï¸ è¯·å®Œæ•´è§‚çœ‹è§†é¢‘ï¼Œä¸­é€”å…³é—­å°†æ— æ³•è·å¾—ç§¯åˆ†
        </div>
        
        <div class="rules">
            <h3>ğŸ“Œ å¥–åŠ±è§„åˆ™</h3>
            <ul>
                <li>ç¬¬1æ¬¡è§‚çœ‹ï¼š10 ç§¯åˆ†</li>
                <li>ç¬¬2æ¬¡è§‚çœ‹ï¼š6 ç§¯åˆ†</li>
                <li>ç¬¬3æ¬¡è§‚çœ‹ï¼š3-10 ç§¯åˆ†ï¼ˆéšæœºï¼‰</li>
            </ul>
        </div>
        
        <button class="watch-btn" id="watchBtn" onclick="startWatch()">
            â–¶ï¸ å¼€å§‹è§‚çœ‹
        </button>
        
        <div class="status" id="status"></div>
        
        <a href="https://t.me/ä½ çš„æœºå™¨äººç”¨æˆ·å" class="back-link">â† è¿”å›æœºå™¨äºº</a>
    </div>
    
    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10489957' data-sdk='show_10489957'></script>
    
    <script>
        // API åŸºç¡€åœ°å€ï¼ˆä½ çš„ Railway éƒ¨ç½²åœ°å€ï¼‰
        const API_BASE = 'https://ä½ çš„é¡¹ç›®å.up.railway.app';
        
        // ä» URL è·å–ç”¨æˆ· ID
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        
        // å½“å‰ä»¤ç‰Œ
        let currentToken = null;
        
        // é˜²ä½œå¼Šï¼šé¡µé¢åŠ è½½æ—¶é—´
        const pageLoadTime = Date.now();
        
        // é˜²ä½œå¼Šï¼šæ£€æµ‹å¼€å‘è€…å·¥å…·
        let devToolsOpen = false;
        const threshold = 160;
        
        setInterval(() => {
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            devToolsOpen = widthThreshold || heightThreshold;
        }, 500);
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setButtonLoading(loading) {
            const btn = document.getElementById('watchBtn');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> åŠ è½½ä¸­...';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'â–¶ï¸ å¼€å§‹è§‚çœ‹';
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·
        if (!userId) {
            showStatus('âŒ æ— æ•ˆçš„è®¿é—®ï¼Œè¯·ä»æœºå™¨äººå†…æ‰“å¼€', 'error');
            document.getElementById('watchBtn').disabled = true;
        }
        
        // è·å–ä»¤ç‰Œ
        async function getToken() {
            try {
                const response = await fetch(`${API_BASE}/api/ad/token/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.token;
                } else {
                    showStatus('âŒ ' + data.message, 'error');
                    return null;
                }
            } catch (error) {
                console.error('Error getting token:', error);
                showStatus('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                return null;
            }
        }
        
        // éªŒè¯å¹¿å‘Šè§‚çœ‹
        async function verifyAdWatch(token) {
            try {
                const response = await fetch(`${API_BASE}/api/ad/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error verifying ad watch:', error);
                return { success: false, message: 'ç½‘ç»œé”™è¯¯' };
            }
        }
        
        // å¼€å§‹è§‚çœ‹
        async function startWatch() {
            // é˜²ä½œå¼Šæ£€æŸ¥
            if (devToolsOpen) {
                showStatus('âŒ è¯·å…³é—­å¼€å‘è€…å·¥å…·åé‡è¯•', 'error');
                return;
            }
            
            // æ£€æŸ¥é¡µé¢åŠ è½½æ—¶é—´ï¼ˆé˜²æ­¢ç›´æ¥è°ƒç”¨APIï¼‰
            if (Date.now() - pageLoadTime < 2000) {
                showStatus('âŒ è¯·ç¨åå†è¯•', 'error');
                return;
            }
            
            if (!userId) {
                showStatus('âŒ æ— æ•ˆçš„ç”¨æˆ·', 'error');
                return;
            }
            
            setButtonLoading(true);
            showStatus('æ­£åœ¨åŠ è½½å¹¿å‘Š...', 'loading');
            
            // è·å–ä»¤ç‰Œ
            currentToken = await getToken();
            
            if (!currentToken) {
                setButtonLoading(false);
                return;
            }
            
            // è®°å½•å¼€å§‹è§‚çœ‹æ—¶é—´
            const watchStartTime = Date.now();
            
            try {
                // è°ƒç”¨ Monetag SDK æ˜¾ç¤ºå¹¿å‘Š
                if (typeof show_10489957 === 'function') {
                    show_10489957('pop').then(async () => {
                        // é˜²ä½œå¼Šï¼šæ£€æŸ¥è§‚çœ‹æ—¶é•¿ï¼ˆè‡³å°‘5ç§’ï¼‰
                        const watchDuration = Date.now() - watchStartTime;
                        if (watchDuration < 5000) {
                            showStatus('âŒ è§‚çœ‹æ—¶é—´è¿‡çŸ­ï¼Œè¯·å®Œæ•´è§‚çœ‹è§†é¢‘', 'error');
                            setButtonLoading(false);
                            return;
                        }
                        
                        // å¹¿å‘Šè§‚çœ‹å®Œæˆï¼ŒéªŒè¯å¹¶é¢†å–ç§¯åˆ†
                        showStatus('æ­£åœ¨éªŒè¯...', 'loading');
                        
                        const result = await verifyAdWatch(currentToken);
                        
                        if (result.success) {
                            showStatus(`ğŸ‰ ${result.message} (ä»Šæ—¥ ${result.watch_count}/3)`, 'success');
                            
                            // 3ç§’ååˆ·æ–°é¡µé¢
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        } else {
                            showStatus('âŒ ' + result.message, 'error');
                        }
                        
                        setButtonLoading(false);
                    }).catch((e) => {
                        console.error('Ad error:', e);
                        showStatus('âŒ å¹¿å‘ŠåŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        setButtonLoading(false);
                    });
                } else {
                    showStatus('âŒ å¹¿å‘Šç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                    setButtonLoading(false);
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('âŒ å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                setButtonLoading(false);
            }
        }
        
        // é˜²ä½œå¼Šï¼šç¦ç”¨å³é”®èœå•
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        
        // é˜²ä½œå¼Šï¼šç¦ç”¨æŸäº›å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœ‹è§†é¢‘å¾—ç§¯åˆ†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            color: #666;
        }

        .status-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .status-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .reward-info {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .reward-info h3 {
            font-size: 14px;
            color: #c0392b;
            margin-bottom: 8px;
        }

        .reward-info p {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .btn {
            width: 100%;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: #fff;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .result.show {
            display: block;
        }

        .result-success {
            color: #27ae60;
        }

        .result-error {
            color: #e74c3c;
        }

        .result h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .result p {
            font-size: 16px;
            color: #666;
        }

        .points-earned {
            font-size: 48px;
            font-weight: bold;
            color: #f39c12;
            margin: 15px 0;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* é˜²ä½œå¼Šé®ç½© */
        .anti-cheat-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 18px;
            text-align: center;
        }

        .anti-cheat-overlay.show {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- é˜²ä½œå¼Šé®ç½© -->
    <div id="antiCheatOverlay" class="anti-cheat-overlay">
        <div>
            <p>âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º</p>
            <p>è¯·æ­£å¸¸è§‚çœ‹å¹¿å‘Š</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¬ çœ‹è§†é¢‘å¾—ç§¯åˆ†</h1>
            <p>è§‚çœ‹å®Œæ•´è§†é¢‘å³å¯è·å¾—ç§¯åˆ†å¥–åŠ±</p>
        </div>

        <!-- åˆå§‹çŠ¶æ€ -->
        <div id="initialState">
            <div class="status-card">
                <div class="status-icon">ğŸ“º</div>
                <div class="status-text">å‡†å¤‡è§‚çœ‹è§†é¢‘å¹¿å‘Š</div>
            </div>

            <div class="reward-info">
                <h3>ğŸ ç§¯åˆ†å¥–åŠ±è§„åˆ™</h3>
                <p>
                    â€¢ ç¬¬ 1 æ¬¡è§‚çœ‹ï¼šè·å¾— <strong>10</strong> ç§¯åˆ†<br>
                    â€¢ ç¬¬ 2 æ¬¡è§‚çœ‹ï¼šè·å¾— <strong>6</strong> ç§¯åˆ†<br>
                    â€¢ ç¬¬ 3 æ¬¡è§‚çœ‹ï¼šè·å¾— <strong>3-10</strong> éšæœºç§¯åˆ†<br>
                    â€¢ æ¯æ—¥æœ€å¤šè§‚çœ‹ 3 æ¬¡
                </p>
            </div>

            <div class="warning">
                âš ï¸ è¯·å®Œæ•´è§‚çœ‹è§†é¢‘ï¼Œä¸­é€”é€€å‡ºå°†æ— æ³•è·å¾—ç§¯åˆ†
            </div>

            <button id="watchBtn" class="btn btn-primary" onclick="startWatching()">
                â–¶ï¸ å¼€å§‹è§‚çœ‹
            </button>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½å¹¿å‘Šï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- è§‚çœ‹ä¸­çŠ¶æ€ -->
        <div id="watchingState" class="loading">
            <div class="status-card">
                <div class="status-icon">ğŸ‘€</div>
                <div class="status-text">æ­£åœ¨è§‚çœ‹å¹¿å‘Š...</div>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">
                    è¯·è€å¿ƒç­‰å¾…å¹¿å‘Šæ’­æ”¾å®Œæˆ
                </p>
            </div>
        </div>

        <!-- æˆåŠŸçŠ¶æ€ -->
        <div id="successState" class="result">
            <div class="status-icon">ğŸ‰</div>
            <h2 class="result-success">æ­å–œè·å¾—ç§¯åˆ†ï¼</h2>
            <div class="points-earned">+<span id="earnedPoints">0</span></div>
            <p id="remainingText">ä»Šæ—¥å‰©ä½™è§‚çœ‹æ¬¡æ•°ï¼š0 æ¬¡</p>
            <button class="btn btn-secondary" onclick="closeWebApp()">
                è¿”å›æœºå™¨äºº
            </button>
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="errorState" class="result">
            <div class="status-icon">ğŸ˜¢</div>
            <h2 class="result-error">è·å–å¤±è´¥</h2>
            <p id="errorText">å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•</p>
            <button class="btn btn-secondary" onclick="closeWebApp()">
                è¿”å›æœºå™¨äºº
            </button>
        </div>

        <!-- å·²è¾¾ä¸Šé™çŠ¶æ€ -->
        <div id="maxReachedState" class="result">
            <div class="status-icon">â°</div>
            <h2>ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ</h2>
            <p>æ˜å¤©å†æ¥å§~</p>
            <button class="btn btn-secondary" onclick="closeWebApp()">
                è¿”å›æœºå™¨äºº
            </button>
        </div>
    </div>

    <div class="footer">
        <p>æ¯æ—¥åŒ—äº¬æ—¶é—´ 00:00 é‡ç½®è§‚çœ‹æ¬¡æ•°</p>
    </div>

    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10489957' data-sdk='show_10489957'></script>

    <script>
        // é…ç½®
        const API_BASE_URL = 'web-production-ef660.up.railway.app'; // æ›¿æ¢ä¸ºä½ çš„ Railway API URL
        
        // è·å– URL å‚æ•°ä¸­çš„ token
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // é˜²ä½œå¼Šå˜é‡
        let watchStartTime = 0;
        let isWatching = false;
        let adCompleted = false;
        let verificationPassed = false;

        // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼ˆé˜²ä½œå¼Šï¼‰
        document.addEventListener('visibilitychange', function() {
            if (isWatching && document.hidden) {
                // ç”¨æˆ·åˆ‡æ¢äº†é¡µé¢
                console.log('æ£€æµ‹åˆ°é¡µé¢åˆ‡æ¢');
            }
        });

        // åˆå§‹åŒ–æ£€æŸ¥
        window.onload = function() {
            if (!token) {
                showError('æ— æ•ˆçš„è®¿é—®é“¾æ¥ï¼Œè¯·ä»æœºå™¨äººé‡æ–°è¿›å…¥');
                return;
            }
            
            // æ£€æŸ¥ token æœ‰æ•ˆæ€§
            checkTokenStatus();
        };

        // æ£€æŸ¥ Token çŠ¶æ€
        async function checkTokenStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ad/status?token=${token}`);
                const data = await response.json();
                
                if (!response.ok) {
                    showError(data.detail || 'é“¾æ¥å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è·å–');
                    return;
                }
                
                if (data.watch_count >= data.max_watches) {
                    showMaxReached();
                    return;
                }
                
                // Token æœ‰æ•ˆï¼Œæ˜¾ç¤ºåˆå§‹çŠ¶æ€
                showState('initialState');
                
            } catch (error) {
                console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å¼€å§‹è§‚çœ‹å¹¿å‘Š
        async function startWatching() {
            if (!token) {
                showError('æ— æ•ˆçš„ Token');
                return;
            }

            const watchBtn = document.getElementById('watchBtn');
            watchBtn.disabled = true;
            
            showState('loadingState');

            try {
                // å…ˆéªŒè¯ Token
                const verifyResponse = await fetch(`${API_BASE_URL}/api/ad/verify?token=${token}`, {
                    method: 'POST'
                });
                
                const verifyData = await verifyResponse.json();
                
                if (!verifyResponse.ok) {
                    showError(verifyData.detail || 'éªŒè¯å¤±è´¥');
                    return;
                }
                
                verificationPassed = true;
                
                // è®°å½•å¼€å§‹æ—¶é—´
                watchStartTime = Date.now();
                isWatching = true;
                
                showState('watchingState');
                
                // è°ƒç”¨ Monetag SDK æ˜¾ç¤ºå¹¿å‘Š
                if (typeof show_10489957 === 'function') {
                    show_10489957('pop').then(() => {
                        // å¹¿å‘Šè§‚çœ‹å®Œæˆ
                        adCompleted = true;
                        handleAdComplete();
                    }).catch((e) => {
                        // å¹¿å‘Šé”™è¯¯æˆ–è¢«å…³é—­
                        console.error('å¹¿å‘Šé”™è¯¯:', e);
                        isWatching = false;
                        
                        // æ£€æŸ¥æ˜¯å¦è§‚çœ‹äº†è¶³å¤Ÿæ—¶é—´ï¼ˆè‡³å°‘5ç§’ï¼‰
                        const watchDuration = Date.now() - watchStartTime;
                        if (watchDuration < 5000) {
                            showError('è¯·å®Œæ•´è§‚çœ‹å¹¿å‘Šåå†é¢†å–å¥–åŠ±');
                        } else {
                            // å¯èƒ½æ˜¯å¹¿å‘Šè¢«æ­£å¸¸å…³é—­
                            handleAdComplete();
                        }
                    });
                } else {
                    // SDK æœªåŠ è½½ï¼Œæ¨¡æ‹Ÿå¹¿å‘Š
                    console.warn('Monetag SDK æœªåŠ è½½ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                    setTimeout(() => {
                        adCompleted = true;
                        handleAdComplete();
                    }, 3000);
                }
                
            } catch (error) {
                console.error('å¼€å§‹è§‚çœ‹å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å¤„ç†å¹¿å‘Šå®Œæˆ
        async function handleAdComplete() {
            isWatching = false;
            
            // æ£€æŸ¥è§‚çœ‹æ—¶é•¿ï¼ˆé˜²ä½œå¼Šï¼‰
            const watchDuration = Date.now() - watchStartTime;
            if (watchDuration < 3000) {
                showError('è§‚çœ‹æ—¶é—´è¿‡çŸ­ï¼Œè¯·å®Œæ•´è§‚çœ‹å¹¿å‘Š');
                return;
            }
            
            if (!verificationPassed) {
                showError('éªŒè¯æœªé€šè¿‡ï¼Œè¯·é‡è¯•');
                return;
            }
            
            showState('loadingState');
            
            try {
                // é¢†å–å¥–åŠ±
                const claimResponse = await fetch(`${API_BASE_URL}/api/ad/claim?token=${token}`, {
                    method: 'POST'
                });
                
                const claimData = await claimResponse.json();
                
                if (!claimResponse.ok) {
                    showError(claimData.detail || 'é¢†å–å¤±è´¥');
                    return;
                }
                
                // æ˜¾ç¤ºæˆåŠŸ
                showSuccess(claimData.reward, claimData.remaining);
                
            } catch (error) {
                console.error('é¢†å–å¥–åŠ±å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showState(stateId) {
            const states = ['initialState', 'loadingState', 'watchingState', 'successState', 'errorState', 'maxReachedState'];
            states.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = id === stateId ? 'block' : 'none';
                    if (id === stateId && (id === 'loadingState' || id === 'watchingState')) {
                        el.classList.add('show');
                    } else {
                        el.classList.remove('show');
                    }
                }
            });
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess(points, remaining) {
            document.getElementById('earnedPoints').textContent = points;
            document.getElementById('remainingText').textContent = `ä»Šæ—¥å‰©ä½™è§‚çœ‹æ¬¡æ•°ï¼š${remaining} æ¬¡`;
            showState('successState');
            document.getElementById('successState').classList.add('show');
            
            // æŒ¯åŠ¨åé¦ˆ
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showState('errorState');
            document.getElementById('errorState').classList.add('show');
            
            // æŒ¯åŠ¨åé¦ˆ
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // æ˜¾ç¤ºå·²è¾¾ä¸Šé™
        function showMaxReached() {
            showState('maxReachedState');
            document.getElementById('maxReachedState').classList.add('show');
        }

        // å…³é—­ WebApp
        function closeWebApp() {
            if (tg) {
                tg.close();
            } else {
                window.close();
            }
        }

        // é˜²ä½œå¼Šï¼šæ£€æµ‹å¼€å‘è€…å·¥å…·
        (function() {
            const devtools = {
                isOpen: false,
                orientation: undefined
            };
            
            const threshold = 160;
            
            const emitEvent = (isOpen, orientation) => {
                if (isOpen && isWatching) {
                    document.getElementById('antiCheatOverlay').classList.add('show');
                }
            };
            
            setInterval(() => {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                const orientation = widthThreshold ? 'vertical' : 'horizontal';
                
                if (!(heightThreshold && widthThreshold) &&
                    ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) ||
                    widthThreshold || heightThreshold)) {
                    if (!devtools.isOpen || devtools.orientation !== orientation) {
                        emitEvent(true, orientation);
                    }
                    devtools.isOpen = true;
                    devtools.orientation = orientation;
                } else {
                    if (devtools.isOpen) {
                        emitEvent(false, undefined);
                    }
                    devtools.isOpen = false;
                    devtools.orientation = undefined;
                }
            }, 500);
        })();
    </script>
</body>
</html>

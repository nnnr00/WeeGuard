<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§‚çœ‹å¹¿å‘Šé¢†å–ç§¯åˆ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #fff;
        }

        .description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .status-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .status-value {
            font-weight: bold;
            color: #4ade80;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .message.success {
            display: block;
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .message.error {
            display: block;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            color: #fbbf24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }

        .reward-info {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .reward-info h3 {
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #fbbf24;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }

        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(74, 222, 128, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #4ade80;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="initial-state">
            <div class="icon">ğŸ¬</div>
            <h1>è§‚çœ‹è§†é¢‘é¢†å–ç§¯åˆ†</h1>
            <p class="description">
                å®Œæ•´è§‚çœ‹è§†é¢‘å¹¿å‘Šåå³å¯è·å¾—ç§¯åˆ†å¥–åŠ±<br>
                è¯·å‹¿ä¸­é€”é€€å‡ºï¼Œå¦åˆ™æ— æ³•è·å¾—ç§¯åˆ†
            </p>

            <div class="reward-info">
                <h3>ğŸ ç§¯åˆ†å¥–åŠ±è§„åˆ™</h3>
                <p>ç¬¬1æ¬¡è§‚çœ‹ï¼š+10 ç§¯åˆ†</p>
                <p>ç¬¬2æ¬¡è§‚çœ‹ï¼š+6 ç§¯åˆ†</p>
                <p>ç¬¬3æ¬¡è§‚çœ‹ï¼š+3~10 ç§¯åˆ†</p>
            </div>

            <div class="status-box" id="status-box">
                <div class="status-item">
                    <span class="status-label">ç”¨æˆ·ID</span>
                    <span class="status-value" id="user-id-display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä»Šæ—¥å·²è§‚çœ‹</span>
                    <span class="status-value" id="watch-count">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å‰©ä½™æ¬¡æ•°</span>
                    <span class="status-value" id="remaining">-</span>
                </div>
            </div>

            <button class="btn" id="watch-btn" onclick="startWatchAd()">
                â–¶ï¸ å¼€å§‹è§‚çœ‹å¹¿å‘Š
            </button>

            <div class="warning">
                âš ï¸ æ³¨æ„ï¼šè¯·å®Œæ•´è§‚çœ‹è§†é¢‘ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯è§‚çœ‹çŠ¶æ€
            </div>

            <div class="security-badge">
                ğŸ”’ å®‰å…¨éªŒè¯å·²å¯ç”¨
            </div>
        </div>

        <div id="loading-state" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½å¹¿å‘Š...</p>
        </div>

        <div id="watching-state" class="hidden">
            <div class="icon">ğŸ“º</div>
            <h1>å¹¿å‘Šæ’­æ”¾ä¸­</h1>
            <p class="description">è¯·å®Œæ•´è§‚çœ‹è§†é¢‘å¹¿å‘Š</p>
            <div class="countdown" id="countdown">--</div>
            <p>ç§’åå¯é¢†å–å¥–åŠ±</p>
        </div>

        <div id="success-state" class="hidden">
            <div class="icon">ğŸ‰</div>
            <h1>æ­å–œè·å¾—ç§¯åˆ†ï¼</h1>
            <div class="status-box">
                <div class="status-item">
                    <span class="status-label">è·å¾—ç§¯åˆ†</span>
                    <span class="status-value" id="earned-points">+0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å½“å‰æ€»ç§¯åˆ†</span>
                    <span class="status-value" id="total-points">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä»Šæ—¥å‰©ä½™æ¬¡æ•°</span>
                    <span class="status-value" id="final-remaining">0</span>
                </div>
            </div>
            <button class="btn btn-success" onclick="goBackToTelegram()">
                âœ… è¿”å› Telegram
            </button>
            <button class="btn btn-secondary" onclick="watchAgain()" id="watch-again-btn">
                ğŸ”„ å†çœ‹ä¸€æ¬¡
            </button>
        </div>

        <div id="error-state" class="hidden">
            <div class="icon">âŒ</div>
            <h1>å‡ºé”™äº†</h1>
            <p class="description" id="error-message">å‘ç”ŸæœªçŸ¥é”™è¯¯</p>
            <button class="btn btn-secondary" onclick="location.reload()">
                ğŸ”„ é‡è¯•
            </button>
            <button class="btn" onclick="goBackToTelegram()">
                ğŸ”™ è¿”å› Telegram
            </button>
        </div>

        <div id="exhausted-state" class="hidden">
            <div class="icon">â°</div>
            <h1>ä»Šæ—¥æ¬¡æ•°å·²ç”¨å®Œ</h1>
            <p class="description">
                æ¯æ—¥è§‚çœ‹æ¬¡æ•°ä¸Šé™ä¸º 3 æ¬¡<br>
                åŒ—äº¬æ—¶é—´ 00:00 é‡ç½®
            </p>
            <button class="btn" onclick="goBackToTelegram()">
                ğŸ”™ è¿”å› Telegram
            </button>
        </div>
    </div>

    <script src='//libtl.com/sdk.js' data-zone='10489957' data-sdk='show_10489957'></script>

    <script>
        const API_BASE_URL = 'https://your-railway-app.up.railway.app';
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('user_id');

        const pageLoadTime = Date.now();
        let adStartTime = null;
        let adCompleted = false;

        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            
            return {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: screen.width + 'x' + screen.height,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvas: canvas.toDataURL().slice(-50)
            };
        }

        async function init() {
            if (!token || !userId) {
                showError('æ— æ•ˆçš„è®¿é—®é“¾æ¥ï¼Œè¯·ä» Telegram æœºå™¨äººè·å–');
                return;
            }

            document.getElementById('user-id-display').textContent = userId;

            try {
                const response = await fetch(API_BASE_URL + '/api/ad/status/' + userId);
                const data = await response.json();

                document.getElementById('watch-count').textContent = data.watch_count + '/3';
                document.getElementById('remaining').textContent = data.remaining;

                if (data.remaining <= 0) {
                    showState('exhausted-state');
                }
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function showState(stateId) {
            const states = ['initial-state', 'loading-state', 'watching-state', 'success-state', 'error-state', 'exhausted-state'];
            states.forEach(function(id) {
                var el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    if (id === 'loading-state') {
                        el.classList.remove('active');
                    }
                }
            });
            
            var targetEl = document.getElementById(stateId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
                if (stateId === 'loading-state') {
                    targetEl.classList.add('active');
                }
            }
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showState('error-state');
        }

        async function startWatchAd() {
            var watchBtn = document.getElementById('watch-btn');
            watchBtn.disabled = true;
            
            showState('loading-state');
            adStartTime = Date.now();

            try {
                if (typeof show_10489957 === 'function') {
                    show_10489957('pop').then(async function() {
                        adCompleted = true;
                        var watchDuration = Date.now() - adStartTime;

                        if (watchDuration < 5000) {
                            showError('è§‚çœ‹æ—¶é—´è¿‡çŸ­ï¼Œè¯·å®Œæ•´è§‚çœ‹å¹¿å‘Š');
                            return;
                        }

                        await claimReward();
                    }).catch(function(error) {
                        console.error('å¹¿å‘Šæ’­æ”¾é”™è¯¯:', error);
                        showError('å¹¿å‘ŠåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
                } else {
                    console.warn('Monetag SDK æœªåŠ è½½ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                    showState('watching-state');
                    
                    var countdown = 5;
                    var countdownEl = document.getElementById('countdown');
                    
                    var timer = setInterval(function() {
                        countdown--;
                        countdownEl.textContent = countdown;
                        
                        if (countdown <= 0) {
                            clearInterval(timer);
                            adCompleted = true;
                            claimReward();
                        }
                    }, 1000);
                    
                    countdownEl.textContent = countdown;
                }
            } catch (error) {
                console.error('å¯åŠ¨å¹¿å‘Šå¤±è´¥:', error);
                showError('å¹¿å‘ŠåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function claimReward() {
            if (!adCompleted) {
                showError('è¯·å…ˆå®Œæ•´è§‚çœ‹å¹¿å‘Š');
                return;
            }

            showState('loading-state');

            try {
                var fingerprint = getDeviceFingerprint();
                
                var response = await fetch(API_BASE_URL + '/api/ad/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        user_id: userId,
                        watch_duration: Date.now() - adStartTime,
                        fingerprint: fingerprint
                    })
                });

                var data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'éªŒè¯å¤±è´¥');
                }

                document.getElementById('earned-points').textContent = '+' + data.points_earned;
                document.getElementById('total-points').textContent = data.total_points;
                document.getElementById('final-remaining').textContent = data.remaining;

                if (data.remaining <= 0) {
                    document.getElementById('watch-again-btn').classList.add('hidden');
                }

                showState('success-state');

            } catch (error) {
                console.error('é¢†å–å¥–åŠ±å¤±è´¥:', error);
                showError(error.message || 'é¢†å–ç§¯åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function goBackToTelegram() {
            window.close();
            
            setTimeout(function() {
                window.location.href = 'https://t.me';
            }, 500);
        }

        function watchAgain() {
            adCompleted = false;
            adStartTime = null;
            showState('initial-state');
            document.getElementById('watch-btn').disabled = false;
            init();
        }

        document.addEventListener('DOMContentLoaded', init);

        document.addEventListener('visibilitychange', function() {
            if (document.hidden && adStartTime && !adCompleted) {
                console.warn('ç”¨æˆ·åœ¨å¹¿å‘Šæ’­æ”¾æœŸé—´åˆ‡æ¢äº†é¡µé¢');
            }
        });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
